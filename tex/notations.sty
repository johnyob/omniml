\RequirePackage{metavar}
\RequirePackage{boolean}
\RequirePackage{stmaryrd}
\RequirePackage{cancel}

%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand \kwd[1]{\mathsf{#1}}
\newcommand \mathpostfix[2][\kwd]{\mathrel{#1{#2}}\mathclose{}}
\newcommand \mathprefix [2][\kwd]{\mathopen{}\mathrel{#1{#2}}}
\newcommand \mathinfix [2][\kwd]{\mathrel{#1{#2}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Constraints / Semantics

\newcommand{\Let}{\mathprefix{let}}
\newcommand{\In}{\mathinfix{in}}
\newcommand{\MLet}{\mathprefix{\textsl{let}}}
\newcommand{\MIn}{\mathinfix{\textsl{in}}}
\newcommand{\Match}{\mathprefix{match}}
\newcommand{\With}{\mathinfix{with}}
\newcommand{\Matches}{\mathinfix{matches}}

\let \latexc \c
\let \c \relax
\defmetavar[s]{\c}{C}
\defmetavar{\C}{\mathscr{C}}
\newcommand{\ctrue}{\mathsf{true}}
\newcommand{\cfalse}{\mathsf{false}}
\newcommand{\cexists}[2]{\exists {#1}.\, #2}
\newcommand{\cfor}[2]{\forall {#1}.\, #2}
\newcommand{\call}[2]{\forall {#1}.\, #2}
\newcommand{\cand}{\wedge}
\newcommand{\cAnd}{\bigwedge}
\newcommand{\cunif}[2]{{#1} = {#2}}
\newcommand{\cinst}[2]{#1 \; #2}
\newcommand{\cleq}[2]{#1 \leq #2}
\newcommand{\cletG}[2][\G]{\Let #1 \In #2}
\newcommand{\cletin}[3]{\Let #1 = #2 \In #3}
\newcommand{\cabs}[2]{\lambda {#1}. \,{#2}}
\newcommand{\cabsr}[3]{\cabs {{#1}\where{#2}} {#3}}
\newcommand{\capp}[2]{#1 \; #2}
\newcommand{\cmatch}[2]{\Match #1 \With #2}
\newcommand{\cmatchdots}[1]{\Match #1 \With \dots}
\newcommand{\clet}[4]{\cletin {#1}{\cabs{#2}{#3}}{#4}}
\newcommand{\Clet}[4]{\Let #1\; #2 = #3 \In #4}
\newcommand{\cletr}[5]{\Clet{#1}{#2\;\where{#3}}{#4}{#5}}
\newcommand{\cdefault}[1]{\mathinfix{default} #1}

\newcommand{\Csuspend}[4]{\cmatch {#1}{#3}{\clam {#2}{#4}}}
\newcommand{\csuspend}[4]{#1?#2 [#3]\to}

\newcommand{\cwild}{\wild}


\newcommand{\cmatchesz}[3]{\cmatch {#1 \is #2} {#3}}
\newcommand{\cmatched}[3]{\cmatch {#1 \is #2} {#3}}

% Patterns / branches
\defmetavar[s]{\cpat}{\rho}
\newcommand{\cpatprod}[2]{\Pi~{{#1}_{#2}}}
\newcommand{\cpatpoly}[1]{\tpoly {#1}}
\newcommand{\cpatwild}{\wild}
\newcommand{\cpatrcd}[1]{\Tapp[#1]\wild}
\defmetavar{\cscm}{s}
\defmetavar{\ct}{t}
\defmetavar[s,as,bs]{\cbr}{\chi}
\newcommand{\cbranch}[2]{#1 \to #2}

% Partial applications

\defmetavar{\inst}{i}
\newcommand{\insts}[1]{\mathsf{insts}(#1)}
\newcommand{\cexistsi}[3]{\cexists {#1^{#2}} #3}
\newcommand{\cpinst}[3]{{#1} \where{{#2} \rightsquigarrow{#3}}}
\newcommand{\cpapp}[4]{{#4}^{#1} \where{{#2} \rightsquigarrow {#3}}}
\defmetavar{\ren}{\rho}
\newcommand{\renroot}[1]{\mathprefix{root}(#1)}
\newcommand{\renreg}[1]{\mathprefix{reg}(#1)}
\newcommand{\reg}[2]{#1, #2}

% Unification problems

\defmetavar{\up}{U}
\defmetavar[s]{\ueq}{\epsilon}
\defmetavar{\Up}{\mathscr{U}}

% Equivalences

\newcommand{\cequiv}{\equiv}
\newcommand{\cnequiv}{\nequiv}
\newcommand{\cequivctx}{\cequiv_{\mathrm{ctx}}}
\newcommand{\cctxequiv}{\equiv_{\square}}
\newcommand{\centails}{\vDash}
\newcommand{\ncentails}{\nvDash}
\newcommand{\Cmatches}[3]{#1 \Matches #2\;#3}
\newcommand{\cmatches}[5][=]{\Cmatches {#2}{#3}{#4} #1 #5}

% Solving

\newcommand{\bvs}[1]{\mathsf{bv}({#1})}
\newcommand{\csolve}{\longrightarrow}
\newcommand{\cnsolve}{\longarrownot\longrightarrow}
\newcommand{\unif}{\longrightarrow}
\newcommand{\Determines}{\mathinfix{determines}}
\newcommand{\cdetermines}[2]{#1 \Determines #2}
\newcommand{\cyclic}[1]{\mathprefix{cyclic}(#1)}
\newcommand{\acyclic}[1]{\mathprefix{acyclic}(#1)}
\newcommand{\trivial}[1]{\mathprefix{trivial}(#1)}

% Semantics

\defmetavar{\semenv}{\phi}
\newcommand{\cerase}[1]{\floor {#1}}
\defmetavar{\deriv}{\mathscr{D}}

% Generation

\newcommand{\ctxinfer}[3]{\csem {#1 \where {\square : #2} : #3}}
\newcommand{\csem}[1]{\bbrackets {#1}}
\newcommand{\cinfer}[2]{\csem {#1 : #2}}
\newcommand{\cinferlab}[4]{\csem {#1 : \Tapp[#2] #3 \to #4}}
\newcommand{\cinferlabuni}[2]{\csem {#1 \uni #2}}
\newcommand{\cinferassn}[3]{\csem {#1 = #2 : #3}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Types / Shapes

\let \latext \t
\let \t \relax
\defmetavar[j]{\t}{\tau}
\defmetavar[s,ps,j]{\tva}{\alpha}
\defmetavar[s,ps,j]{\tvb}{\beta}
\defmetavar[s,ps,j]{\tvc}{\gamma}
\defmetavar[s,ps]{\tvd}{\delta}
%% Aliases for \tva
\defmetavar[s,ps,j]{\tv}{\alpha}
\defmetavar[s]{\av} {\varepsilon}
\defmetavar[s,j,as,bs] {\ty} {\tau}
\newcommand{\typs}{{\bar\ty'}}

% Ground types
\defmetavar[s]{\gt}{{\mathfrak{g}}}
\defmetavar{\gabs}{\mathfrak{G}}
\defmetavar{\gabsr}{\mathfrak{R}}
\newcommand{\GroundRegion}{\mathcal{R}}
\defmetavar{\gr}{\mathfrak{r}}
\newcommand{\greg}[2]{#1 \where{#2}}
\newcommand{\gregren}[3]{{#1}\where{#2 \is #3}}
\defmetavar{\gscm}{\mathfrak{s}}

% Type constructors
\newcommand{\tarrow}{\to}
\newcommand{\tprod}{\mathbin\ast}
\newcommand{\tProd}[1]{\Pi\iton {#1}}
\newcommand{\tpoly}[1]{\brackets {#1}}
\newcommand{\topoly}[1]{\angles { f : #1}}
\newcommand{\tapoly}[2]{\tpoly{#1}^{#2}}
\newcommand{\tunit}{1}
\newcommand{\tint}{\mathsf{int}}
\newcommand{\tbool}{\mathsf{bool}}
\newcommand{\tlist}{\mathpostfix{list}}
\newcommand{\trec}[2]{\mathprefix{rec}#1.#2}
\newcommand{\tsrecord}[1]{\braces {#1}}

\defmetavar \tconstr {\mathprefix{c}}

\newcommand{\fvs}[1]{\mathsf{fv}({#1})}

\newcommand{\F}{\mathprefix[\mathsf]{F}}
\newcommand{\T}{\mathprefix[\mathsf]{t}}
\newcommand{\Tp}{{\T'}}
\newcommand{\Fapp}[1][\F]{\mathprefix[]{#1}}
\newcommand{\Tapp}[1][\T]{\mathprefix[]{#1}}

% Shapes

\newcommand \sbot {\bot}
\newcommand{\Sh}{\zeta}
\newcommand{\Shp}{\Sh'}
\defmetavar{\sh}{\varsigma}
\newcommand{\shapp}[1][\sh]{#1\,}
\newcommand{\pshapp}{\shapp}
\newcommand{\deshaped}[3]{(\any{#1}{#2}, #3)}
\newcommand{\deshape}[1]{\mathprefix{deshaped}(#1)}
\newcommand{\shape}[1]{\kwd{shape}(#1)}
\newcommand{\decomp}[1]{\mathprefix{decomp}(#1)}

% Type schemes

\defmetavar {\ts} {\sigma}
\newcommand{\tfor}[2]{\forall {#1}.\,{#2}}
\newcommand{\tlab}[3][]{\ifempty{#1}{}{\forall{#1}.\,}#2 \to #3}
\newcommand{\sigmaone}{\ts_1}
\newcommand{\sigmatwo}{\ts_2}
\newcommand{\sigmai}{\ts_i}
\newcommand{\sigman}{\ts_n}

% Variation types
\newcommand \vty [1]{\varpi\ifempty{#1}{}{\parens{#1}}}
\newcommand \vor {\mathbin{\&}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Terms / Typing


\defmetavar {\E} {\mathscr{E}}
\defmetavar {\Lab} {\mathscr{L}}

\defmetavar {\x} {x}
\defmetavar{\M}{M} % module prefix for Leijen
\defmetavar[n,s]{\e}{e}
\newcommand{\econstr}[2]{#1 \@ #2}
\newcommand{\einst}[2][]{\angles {#2\ifempty{#1}{}{:#1}}}
\newcommand{\exinst}[3]{\angles {#1 : \ifempty{#2}{{#3}}{\exi {#2} {#3}}}}
\newcommand{\epoly}[2][]{\tpoly{#2\ifempty{#1}{}{:#1}}}
\newcommand{\expoly}[3]{\epoly {#1 : \exi {#2} {#3}}}
\newcommand{\eunit}{()}
\newcommand{\efun}[2]{\lambda #1. \, #2}
\newcommand{\eifun}[2]{\lambda_{?} #1. \, #2}
\newcommand{\eimplicit}[1]{?#1}
\newcommand{\eapp}[2]{#1 \; #2}
\newcommand{\eappp}[3]{\eapp{\eapp{#1}{#2}}{#3}}
\newcommand{\eApp}{\mathbin{@}}
\newcommand{\ePipe}{\mathbin{\triangleright}}
\newcommand{\elet}[3]{\Let #1 = #2 \In #3}
\newcommand{\ematch}[2]{\Match #1 \With #2}
\newcommand{\ecase}[3]{#1 \; #2 \Rightarrow #3}
\newcommand{\efield}[2]{#1.#2}
\newcommand{\exfield}[3]{#1.{\labfrom {#3}{#2}}}
%% Could be factored as
\newcommand{\exproj}[3]{\eproj[#3] {#1} {#2}}
\newcommand{\eproj}[3][]{#2.#3\ifempty{#1}{}{/#1}}
\newcommand{\erecord}[1]{\braces{#1}}
\newcommand{\exrecord}[2]{{#1}.\braces{#2}}
\defmetavar[s]{\el}{l}
\newcommand{\elmagic}[1]{\braces {#1}}
\newcommand{\elannot}[3]{\parens {{#1} : \ifempty{#2}{#3}{\exi {#2} {#3}}}}
\defmetavar[s]{\elab}{\ell}
\newcommand{\eannot}[3]{\parens {#1 : \ifempty{#2}{#3}{\exi {#2} #3}}}
\newcommand{\etuple}[1]{\parens{#1}}
%% \newcommand \emagic[1]{\set{#1}}
\newcommand{\emagic}[1]{\lbag {#1}\rbag}
\newcommand{\eerase}[1]{\floor {#1}}
\newcommand{\lab}[1]{|#1|}
\newcommand{\exover}[2]{#1.#2}
\newcommand{\eover}[1]{{.#1}}

% Typing contexts
\defmetavar {\G} {\Gamma}
\defmetavar {\Gnil} {\cdot}
\newcommand \labenv {\Omega}
\newcommand \Labenv [1][\T]{\labenv(#1)}
\newcommand \labtyp [2][\T]{(\Labenv[#1])(#2)}
\newcommand \labto [2]{#2 \to #1}
\newcommand \labin {\mathinfix {in}}
\newcommand \labsof {\mathprefix {Labs}}
\newcommand \labfrom [2]{{#2}.#1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Other

% Sets

\newcommand{\Ground}{\mathcal {G}}
\newcommand{\Types}{\mathcal {T}}
\newcommand{\TyVars}{\mathcal{V}}
\newcommand{\Shapesz}{\mathcal {S}}
%% \newcommand{\Shapesz}{\Shapes^\ast}
\newcommand{\Powerset}[1]{\mathcal{P}(#1)}

% Relations

\newcommand{\simple}{\mathpostfix{simple}}
\newcommand{\discriminates}[2]{#1 \mathinfix{discrimitates} #2}
\newcommand{\Discriminates}[2]{#1 \lessdot #2}
\defmetavar{\sub}{\vartheta}
\newcommand{\compose}{\circ}
\newcommand \Cshape[3]{#1 \where {#2 \mathop{!} #3}}
\newcommand \notbang {\rlap{$\diagdown$}\diagup\!\!\!{!}\,}
\newcommand \nCshape[2]{#1 \where {#2 \mathop{\notbang}}}
\newcommand \eshape[4][]{#2 \where {#3 \mathop{\triangleright} {#4} \ifempty{#1}{}{\mid #1}}}
\newcommand \Eshape[3]{#1 \where {\square \mathop{\triangleleft} {#3} \mid #2}}
\newcommand \Lshape[3]{#1 \where {#2 \mathop{!} {#3}}}
\renewcommand {\th}{\vdash}
\newcommand {\thsimple}{\vdash_\mathsf{simple}} % no 'sim' please, it reads as 'simulation'
\newcommand {\throbust}{\vdash_\mathsf{robust}}
\newcommand {\thsimplesd}{\thsimple^{\mathsf{sd}}}
\newcommand{\Th}{\Vdash}
\newcommand {\iton}[1][n]{_{i=1}^{#1}}
\renewcommand{\@}{\;}

% Braces and parens

\newcommand {\parens}[1]{(#1)}
\newcommand {\iparens}[2][\iton]{\parens{#2}#1}
\newcommand {\seq}[2][\iton]{\parens{#2}#1}
\newcommand {\braces}[1]{\{#1\}}
\newcommand {\brackets}[1]{[#1]}
\newcommand {\bbrackets}[1]{\llbracket #1\rrbracket}
\newcommand {\pparens}[1]{\llparenthesis #1 \rrparenthesis}
\newcommand {\ceils}[1]{\lceil #1\rceil}
\newcommand {\floors}[1]{\lfloor #1\rfloor}
\newcommand {\angles}[1]{\langle #1\rangle}
\newcommand {\highdelim}[2]{\left#1{#2\right}}
\newcommand {\Parens}[1]{\highdelim\parens {#1}}
\newcommand {\Braces}[1]{\highdelim\braces {#1}}
\newcommand {\Angles}[1]{\highdelim\angles {#1}}
\newcommand {\Brackets}[1]{\highdelim\brackets {#1}}
\newcommand {\Bbrackets}[1]{\highdelim\bbrackets {#1}}
\newcommand {\floor}[1]{\lfloor #1 \rfloor}
\newcommand {\set}[1]{\braces{#1}}
\newcommand {\eset}{\emptyset}
\newcommand {\where}[1]{\brackets {#1}}
\newcommand {\Where}[1]{\Brackets {#1}}
\newcommand {\is}{:=}

%% wedges

\newcommand {\Lbrace}[2][L]
   {\left\{\begin{tabular}{#1}#2\end{tabular}\right.}
\newcommand {\Wedges}[2][L.R] {\bigwedge \Lbrace[#1]{#2}}
\newcommand {\wedges}[2][]    {{\def \\{\wide\wedge} #2}}

%% Domains
\newcommand{\disjoint}{\mathop{\#}}
\newcommand{\dom}{\mathprefix{dom}}
\newcommand{\Dom}[1]{\dom(#1)}
\newcommand{\rng}{\mathprefix{rng}}

%% Binders

\newcommand{\all}[2]{\forall #1.\,#2}
\newcommand{\exi}[2]{\exists #1.\,#2}
\newcommand{\any}[2]{\nu #1.\,#2}
\newcommand{\uni}[1]{\mathop{!}{#1}}
\newcommand{\unii}[1]{\mathop{!!}{#1}}

\newcommand{\labuni}[2]{#1 \mathrel{\triangleright} #2}
%% \newcommand{\nlabuni}[2]{#1 \mathrel{\not\triangleright} #2}
\newcommand{\labsuni}[2]{#1 \mathrel{\blacktriangleright} #2}

\newcommand{\eqdef}{\mathrel{\triangleq}}

% Spaces

\newcommand \uad [1][1ex]{\hskip #1}
\newcommand \wide[2][\;]{#1 #2 #1}
\newcommand \Wide[2][\uad]{#1 #2 #1}


\newcommand \ehole {\square}
\newcommand \wild {{\_}}
%% \newcommand \ecast [3]{#1  : #2 \bowtie #3}

%% Previously inlined, non-local commands
%% Where non-local means used in other sections

\newcommand{\entailsPf}[3]{\Pf{#1}{\centails}{#2}{#3}}
\newcommand{\VdashPf}[3]{\Pf{#1}{\Vdash}{#2}{#3}}
\newcommand{\ThTypPf}[4]{\Pf{#1}{\Th}{#2 : #3}{#4}}
\newcommand{\thTypPf}[4]{\Pf{#1}{\th}{#2 : #3}{#4}}
\newcommand{\UnifierPf}[3]{\Pf{#1}{\text{unifies}}{#2}{#3}}
\newcommand{\eshapePf}[4]{\Pf{}{}{\eshape {#1} {#2} {#3}}{#4}}
\newcommand{\simplePf}[2]{\Pf{#1}{}{\simple}{#2}}
\newcommand{\nsimplePf}[2]{\Pf{}{\neg}{#1 \simple}{#2}}
\newcommand{\shapePf}[4]{\Pf{}{}{\Cshape {#1} {#2} {#3}}{#4}}
\newcommand{\cnmatches}[1]{\#\Match #1}
\newcommand{\csize}[1]{|#1|}
\newcommand{\cmeasure}[1]{{\| #1 \|}}

\let \latexS \S \let \S \relax

% Strategy
\defmetavar[s]{\suspc}{c}
\newcommand{\S}{{\mathcal S}}
\newcommand{\Sempty}{\S_{\mathbb{0}}}
\newcommand{\Sfull}{\S_{\mathbb{1}}}
\newcommand{\Sopt}{\S_{\textsf{opt}}}

\newcommand{\Sfire}[2]{#1(#2)}
\newcommand{\Ssol}[2][\c]{\Sols [#1]_{#2}}
\newcommand{\Sols}[1][\c]{\bbrackets {#1}}

%% Free type variables
\newcommand{\ftv}{\mathprefix{ftv}}

%% Depenency
\newcommand{\cprec}[1][]{\prec_{#1}}
\newcommand{\cprecsucc}[1][]{\prec\joinrel\succ_{#1}}
\newcommand{\esend}{\,\texttt{\#}\,}
\newcommand{\eobj}[1]{\angles{#1}}
\newcommand{\mall}[2]{#1.\,#2}
\newcommand{\ttlab}[1]{\texttt{#1}}
\newcommand{\ttex}[1]{\texttt{ex}_{\texttt{#1}}}
\newcommand{\epolymeth}[3]{\eobj{\ttlab {#1}:\mall{#2}{#3}}}

\def \ttx {\ttlab x}
\def \tty {\ttlab y}
\def \ttcolor {\ttlab {color}}
\def \ttpoint {\ttlab {point}}
\def \ttgraypoint {\ttlab {gray\_point}}
